<?php include __DIR__ . '/../admin-templates/header.php'; ?>

<div class="container px-6 py-8 mx-auto">
    <h3 class="text-3xl font-medium text-gray-700">Pengelolaan Barang Keluar</h3>

    <div class="flex flex-col mt-8">
        <form id="addBarangKeluarForm">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="id_barang" class="block text-sm font-medium text-gray-700">Nama Barang</label>
                    <select id="id_barang" name="id_barang" class="px-4 py-2 mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:outline-none" required>
                        <option value="">Pilih Barang</option>
                        <?php foreach ($barangList as $barang) : ?>
                            <?php if ($barang['stok'] > 0) : // Check if stock is greater than zero 
                            ?>
                                <option value="<?= $barang['id'] ?>">
                                    <?= $barang['nama_barang'] ?> - Stok: <?= $barang['stok'] ?>
                                </option>
                            <?php endif; ?>
                        <?php endforeach; ?>

                    </select>
                </div>
                <div>
                    <label for="jumlah" class="block text-sm font-medium text-gray-700">Jumlah</label>
                    <input type="number" id="jumlah" name="jumlah" class="px-4 py-2 mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:outline-none" required>
                </div>
            </div>
            <div class="mt-4">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Submit Request</button>
            </div>
        </form>
    </div>

    <div class="mt-8">
        <div class="py-2 overflow-x-auto">
            <div class="min-w-full border-b border-gray-200 shadow sm:rounded-lg">
                <table id="barangKeluarTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be generated by DataTables -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Initialize DataTable for Barang Keluar
        $('#barangKeluarTable').DataTable({
            ajax: {
                url: '/barangkeluar/getall', // URL to fetch data from
                dataSrc: '' // Indicates that data is a flat array
            },
            columns: [{
                    data: 'nama_barang'
                },
                {
                    data: 'jumlah'
                },
                {
                    data: 'created_at',
                    render: function(data, type, row) {
                        return formatDateTime(data); // Format date to "12 Januari 2022 Jam 08:00"
                    }
                },
                {
                    data: 'username'
                },
                {
                    data: 'status',
                    render: function(data, type, row) {
                        if (data === 'pending') {
                            return '<span class="bg-yellow-200 text-yellow-700 px-2 inline-flex text-xs leading-5 font-semibold rounded-full">Pending</span>';
                        } else if (data === 'approved') {
                            return '<span class="bg-green-200 text-green-700 px-2 inline-flex text-xs leading-5 font-semibold rounded-full">Approved</span>';
                        } else if (data === 'rejected') {
                            return '<span class="bg-red-200 text-red-700 px-2 inline-flex text-xs leading-5 font-semibold rounded-full">Rejected</span>';
                        }
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        if (row.status === 'pending') {
                            return '<button class="bg-green-500 text-white px-2 py-1 rounded-md approveBtn" data-id="' + row.id + '">Approve</button>' +
                                '<button class="bg-red-500 text-white px-2 py-1 rounded-md rejectBtn" data-id="' + row.id + '">Reject</button>';
                        } else {
                            return '<span class="text-gray-500">No Actions Available</span>';
                        }
                    }
                }
            ]
        });

        // Form submission for new stock requests
        $('#addBarangKeluarForm').on('submit', function(event) {
            event.preventDefault();
            const formData = $(this).serialize();

            $.ajax({
                url: '/barangkeluar/add',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        $('#barangKeluarTable').DataTable().ajax.reload(); // Reload DataTable data
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil Melakukan Pengajuan',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal Melakukan Pengajuan!',
                            text: response.message || 'Please try again.',
                            showConfirmButton: true
                        });
                    }
                }
            });
        });

        // Approve button click handler
        $('#barangKeluarTable').on('click', '.approveBtn', function() {
            const id = $(this).data('id');
            updateStatus(id, 'approved');
        });

        // Reject button click handler
        $('#barangKeluarTable').on('click', '.rejectBtn', function() {
            const id = $(this).data('id');
            updateStatus(id, 'rejected');
        });

        // Function to update status of a request
        function updateStatus(id, status) {
            $.ajax({
                url: '/barangkeluar/updatestatus',
                type: 'POST',
                data: {
                    id: id,
                    status: status
                },
                success: function(response) {
                    if (response.success) {
                        $('#barangKeluarTable').DataTable().ajax.reload(); // Reload DataTable data
                        Swal.fire({
                            icon: 'success',
                            title: 'Status updated successfully!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed to update status!',
                            text: response.message || 'Please try again.',
                            showConfirmButton: true
                        });
                    }
                }
            });
        }

        // Function to format date and time
        function formatDateTime(dateTimeStr) {
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const date = new Date(dateTimeStr);
            return date.toLocaleDateString('id-ID', options).replace(' at ', ' Jam ');
        }
    });
</script>

<?php include __DIR__ . '/../admin-templates/footer.php'; ?>